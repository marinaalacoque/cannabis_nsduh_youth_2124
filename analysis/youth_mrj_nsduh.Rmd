---
title: "NSDUH project"
author: "Marina Alacoque Rodrigues"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
  word_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Patterns and Trends of Cannabis Use and Mental Health Among U.S. Adolescents(2021–2024)

## 1. Background and Rationale

Prevention of cannabis use among adolescents has become an increasingly important public health priority in the United States (Bhangu et al., 2025). This concern has grown alongside major shifts in cannabis policy, the expansion of new modes of consumption, and a parallel rise in mental health problems among young people (Nguyen et al., 2023; Hammond, et al., 2020). The legalization of recreational and medical cannabis in several U.S. jurisdictions, as well as the decriminalization of possession and use (Mattingly et al., 2024), has increased both access to cannabis and its visibility in everyday life, contributing to broader social acceptance and normalization of use (Farrelly et al., 2023; Lapham et al., 2023; Smart & Pacula, 2019). In 2022, data from the National Survey on Drug Use and Health (NSDUH) indicated that 61.9 million individuals reported cannabis use in the past year, while 42.3 million reported use in the past 30 days, reflecting a continued long-term upward trend (Mattingly et al., 2024; SAMHSA, 2023).Within this evolving context, cannabis has become the most commonly used illicit substance in the United States and the third most frequently used psychoactive substance among adolescents, after alcohol and nicotine (Ross, & Levy, 2023; Nguyen et al., 2023).

At the same time, perceptions of cannabis as a relatively low-risk substance, often reinforced by discussions of potential therapeutic benefits, stand in contrast to a growing body of evidence documenting its adverse health effects (Florimbio et al., 2024; Whiteley et al., 2021). Adolescents may be particularly vulnerable to these effects due to ongoing brain development and the central role of the endocannabinoid system in neural organization, behavioral regulation, and maturation (Scheyer et al., 2023; Hurd et al., 2019). Early exposure to exogenous cannabinoids may therefore confer long-term consequences, including cognitive impairment, emotional dysregulation, and increased risk of psychiatric comorbidity such as depression, anxiety disorders, and psychosis, as well as self-harm behaviors (Bhangu et al., 2025; Florimbio et al., 2024; Scheyer et al., 2023). Prior research indicates that adolescents with any history of cannabis use experience higher rates of lifetime and past-year major depressive disorder (MDD), MDD with severe role impairment, and past-year suicide attempts (all p < 0.001) (Gukasyan and Strain, 2020).

Beyond mental health outcomes, both acute and chronic cannabis use have been linked to impairments in memory, learning, attention, executive functioning, and motor coordination, as well as a greater likelihood of initiating other illicit substances (Queiroz et al., 2025; Camchong et al., 2017). According to the Substance Abuse and Mental Health Services Administration’s report, approximately 10% of individuals who use cannabis develop cannabis use disorder, with this proportion increasing to 16–17% among those who initiate use before the age of 18 (SAMHSA, 2024). Emerging research also points to broader neurobiological effects, including dysregulation of the hypothalamic–pituitary–adrenal axis and disruptions in sleep architecture, underscoring the complex and potentially enduring consequences of cannabis exposure during adolescence (Bhangu et al., 2025; Velzeboer et al., 2025; Cservenka et al., 2018). 

Despite these concerns, important questions remain regarding the causal nature of the relationship between cannabis use and adverse health outcomes, as well as the directionality of these associations. These uncertainties are further heightened by the rapid emergence of high-potency products and alternative modes of consumption, such as vaping concentrates and ingesting edibles, which have become increasingly popular among adolescents in recent years (Lee et al., 2023; Schauer et al., 2020). Notably, vaping illicit cannabis products has been implicated in cases of e-cigarette or vaping product use–associated lung injury (EVALI), which resulted in 2,807 hospitalizations in the United States by 2019 (CDC, 2020).

In this context of changing policies, evolving patterns of use, and ongoing scientific debate, up-to-date and nationally representative evidence is essential to inform public policy, prevention efforts, and youth-focused health education. Accordingly, this study examines recent patterns and trends in cannabis use among U.S. adolescents aged 12–17 years from 2021 to 2024, with particular attention to sociodemographic differences, modes of consumption, and potential associations with mental health outcomes.

## 2.	Objectives

### 2.1. To characterize the sociodemographic profile of adolescents reporting past-year marijuana use.
### 2.2. To estimate the prevalence of different modes of marijuana administration (e.g., smoking, vaping, edibles, concentrates).
### 2.3. To assess temporal trends in use between 2021 and 2024.
### 2.4. To evaluate the association between marijuana use patterns and major depressive episodes.

## 3.	Expected Contributions

This study provides an updated and detailed portrait of adolescent marijuana use in the United States, highlighting its intersection with mental health and contributing to a more nuanced understanding of recent patterns of adolescent use.

## 4.	Methods

### 4.1. Data source and study population

This multi-year cross-sectional study used data from the 2021–2024 National Survey on Drug Use and Health (NSDUH), a nationally representative survey administered by the Substance Abuse and Mental Health Services Administration (SAMHSA). The NSDUH collects information on sociodemographic characteristics, mental health, substance use, and treatment utilization among noninstitutionalized U.S. civilians aged 12 years or older using a multistage, stratified probability sampling design across all states and Washington, DC. Beginning in late 2020, the NSDUH implemented multimodal data collection procedures, including in-person and web-based surveys, in response to disruptions caused by the COVID-19 pandemic (SAMHSA, 2023).

The analytic sample was restricted to adolescents aged 12–17 years who completed the survey between 2021 and 2024 and had complete information on cannabis use, mental health indicators, and sociodemographic variables. The NSDUH applies standardized imputation procedures to address item-level missing data; therefore, the final analytic dataset contained no missing values on study variables. Analysis of these deidentified, publicly available data was considered exempt from institutional review board review per institutional and federal regulations. 

### 4.2. Measures

#### Cannabis use and Mental health outcomes

Cannabis use was assessed via self-report. Past-year cannabis use was defined as any reported use of marijuana during the 12 months preceding the interview (yes/no), and current cannabis use was defined as use within the past 30 days (yes/no). Binary indicators of cannabis use were created to ensure consistency across analytic models and to validate exposure classification using multiple time-based definitions. Beginning in 2021, the NSDUH introduced questions on marijuana vaping within an “emerging issues” section of the questionnaire. The standardized questions assessing multiple modes of marijuana use were implemented consistently starting in 2022. Therefore, analyses of prevalence and mode-specific patterns of marijuana use in the present study were restricted to survey years 2022–2024 to ensure comparability across years. 

Mental health and substance use disorder outcomes were assessed using NSDUH-provided recoded variables for adolescents based on DSM-5 criteria. Past-year major depressive episode (MDE) and substance use disorder (SUD) were operationalized using the variables YMDERSUD5ANY and YMDESUD5ANYO, introduced in the 2021 NSDUH First Findings Report and incorporating DSM-5 SUD estimates, including prescription drug use. The binary variable YMDERSUD5ANY identified adolescents with a past-year MDE, a past-year SUD, or both (yes/no). To characterize comorbidity patterns, the categorical variable YMDESUD5ANYO classified adolescents into four mutually exclusive groups: (1) SUD only, (2) MDE only, (3) both MDE and SUD, and (4) neither condition in the past year. Consistent with NSDUH coding conventions, adolescents aged 18 years or older were excluded from analyses using these variables. These recoded measures replace earlier NSDUH variables (YMDEORSUD5 and YMDESUD5ONL) and were selected to align with updated DSM-5 definitions and post-2020 NSDUH methodology.

#### Sociodemographic characteristics

Sociodemographic characteristics included age (12–13, 14–15, 16–17 years), sex (male, female), race and ethnicity (non-Hispanic White, non-Hispanic Black, American Indian/Alaska Native [AIAN], Native Hawaiian/Other Pacific Islander [NHPI], non-Hispanic Asian, non-Hispanic multiracial, Hispanic), total annual family income (<$10,000, $10,000–$19,999, $20,000–$29,999, $30,000–$39,999, $40,000–$49,999, $50,000–$74,999, ≥$75,000), health insurance status (insured vs uninsured), county type (large metropolitan, small metropolitan, nonmetropolitan), population density (≥1 million, <1 million, non-Core-Based Statistical Area [CBSA]), and household poverty status (living in poverty, up to 2× federal poverty threshold, >2× threshold).

### 4.3. Statistical analysis

Weighted prevalence of past-year cannabis use among U.S. adolescents was estimated for each survey year from 2021 to 2024, overall and stratified by sociodemographic characteristics, modes of use, and mental health status. Temporal trends were assessed by changes in weighted prevalence and 95% confidence interval overlap (two-sided, α < 0.05), and linear trends were evaluated using multivariable survey-weighted logistic regression with year as a continuous variable. Associations between cannabis use and mental health outcomes were examined using survey-weighted chi-square tests and multivariable logistic regression, adjusting for covariates. Separate models evaluated (1) whether past-year marijuana use was associated with MDE or SUD and (2) whether MDE, SUD, or both predicted past-year marijuana use, with adolescents with neither condition as the reference group. All analyses accounted for the NSDUH complex survey design, including stratification and clustering, and were conducted in R (version 4.4.3) using survey-specific procedures; and statistical significance defined as two-sided p < 0.05.

## 5.	Results

### 5.1. Prevalence of past-year marijuana use 

Among the 45,618 adolescents included in our analysis, representing a weighted population of 103,611,766 (SE, 1,409,989) individuals over the study period, 5,358 adolescents (approximately 11.7%) reported using marijuana in the past 12 months, and 2,961 adolescents (approximately 6.5%) reported use in the past 30 days. Weighted prevalence estimates of past-year cannabis use among U.S. adolescents remained relatively stable from 2021 to 2023, with prevalence of 10.8% (95% CI, 9.7–12.0%) in 2021, 11.4% (95% CI, 10.7–12.1%) in 2022, and 11.0% (95% CI, 10.2–11.8%) in 2023. In 2024, prevalence decreased to 10.1% (95% CI, 9.2–11.0%), as shown in Figure 1. In multivariable logistic regression models adjusted for survey design, compared with 2022, the adjusted odds of past-year cannabis use were slightly lower but not statistically significant in 2021 (AOR, 0.95; 95% CI, 0.82–1.09; p = 0.42) and 2023 (AOR, 0.96; 95% CI, 0.86–1.07; p = 0.43), whereas 2024 showed a statistically significant decrease (AOR, 0.87; 95% CI, 0.79–0.97; p = 0.01). Overall, these findings suggest a modest reduction in adolescent cannabis use in 2024, with no clear trend in the preceding years.

### 5.2. Sociodemographic characteristics 

Table 1 shows the weighted prevalence of past-year cannabis use among US adolescents across sociodemographic groups, by year. Overall, prevalence was higher among females than males, ranging from 54.8% (95% CI, 49.9–59.8) in 2021 to 54.5% (95% CI, 50.6–58.5) in 2024 for females, and 45.2% (95% CI, 40.2–50.1) to 45.5% (95% CI, 41.6–49.5) for males. Use increased with age, with adolescents aged 16–17 years reporting the highest prevalence across all years (66.8% [95% CI, 63.0–70.6] in 2021 and 65.3% [95% CI, 61.9–68.8] in 2024). Racial/ethnic differences were observed, with White adolescents reporting the highest prevalence, followed by Hispanic and Black adolescents, whereas Asian, AIAN, Multiracial and NHPI adolescents had lower prevalence estimates. Geographic patterns indicated higher use in large metropolitan areas compared with smaller areas. Prevalence also varied by family income and poverty status, with higher use among adolescents from households with ≥$75,000 annual income and those living more than twice above the federal poverty threshold. Differences across years within most subgroups were modest, with overlapping confidence intervals, indicating no clear temporal trends.

In multivariable-adjusted analyses, older adolescents and females had consistently higher odds of past-year cannabis use (p < 0.001). Elevated odds were also observed among youth from middle-income households ($40,000–$49,999 and $50,000–$74,999), adolescents residing in small metropolitan areas, and American Indian/Alaska Native and multiracial adolescents. In contrast, adolescents living in nonmetropolitan areas and Asian adolescents had significantly lower odds of use (all p < 0.001). Hispanic adolescents had slightly lower odds of current cannabis use but were 46% more likely to report marijuana use disorder compared with non-Hispanic White adolescents (AOR, 1.46; 95% CI, 1.12–1.89). 

### 5.3 Prevalence of different modes of marijuana use among past-year users

Considering different modes of marijuana use, smoking remained the most prevalent method among adolescents across the study period, with prevalence estimates of 76.7% (95% CI, 72.4%–80.9%) in 2022, 79.6% (95% CI, 75.9%–83.2%) in 2023, and 75.4% (95% CI, 71.3%–79.4%) in 2024 (Figure 2). Vaping was the second most common mode of use and demonstrated a significant increasing temporal trend (AOR per year, 1.72; 95% CI, 1.34–2.20; p < .001), with prevalence rising from 60.3% (95% CI, 56.0%–64.6%) in 2022 to 64.8% (95% CI, 60.2%–69.3%) in 2023, and reaching 72.3% (95% CI, 69.0%–75.6%) in 2024.

In contrast, dabbing (waxes or concentrates) showed a decreasing trend over time (AOR per year, 0.70; 95% CI, 0.50–0.99; p = .044), consistent with declining prevalence estimates across survey years. No statistically significant temporal trends were observed for the remaining modes of marijuana use, with less commonly reported methods including oral products (drops or sprays), with prevalences below 3% in all years; topical products, which declined from 7.5% (95% CI, 5.1%–10.0%) in 2022 to 4.4% (95% CI, 2.5%–6.3%) in 2024; and pills and other methods, each consistently reported by fewer than 5% of adolescents.

# 5.4. Past-year marijuana use, and Major Depressive Episode/Substance Use Disorder

In this analysis of adolescents, older age, female sex, and past-year marijuana use were significantly associated with higher odds of experiencing a MDE or SUD. Adolescents aged 14–15 had an AOR of 1.60 (95% CI, 1.46–1.76), and those aged 16–17 had an AOR of 1.79 (95% CI, 1.59–2.01), compared with 12–13-year-olds. Females demonstrated nearly threefold higher odds than males (AOR, 2.86; 95% CI, 2.61–3.13). Family income exhibited limited associations, with only adolescents from households earning $50–74k showing a modestly elevated risk (AOR, 1.13; 95% CI, 1.01–1.26). County type was not significantly associated with the outcome. Regarding race and ethnicity, Black (AOR, 0.71; 95% CI, 0.63–0.80), Asian (AOR, 0.76; 95% CI, 0.61–0.96), and Native Hawaiian/Pacific Islander adolescents (AOR, 0.37; 95% CI, 0.17–0.83) had lower odds compared with non-Hispanic White adolescents, whereas Non-Hispanic multiracial adolescents had higher odds (AOR, 1.27; 95% CI, 1.07–1.51).

Past-year marijuana use was the strongest predictor of MDE/SUD, with users showing markedly increased odds (AOR, 9.62; 95% CI, 8.38–11.04); specifically, adolescents who used marijuana in the past year had substantially higher odds of experiencing SUD only (AOR, 22.15; 95% CI, 18.69–26.25) or comorbid SUD and MDE (AOR, 21.79; 95% CI, 17.00–27.94) compared with those with neither condition in adjusted models.



### 6.	References

Bhangu GK, Singh A, Shah A, Malhi N. Cannabis use in adolescents. Del J Public Health. 2025;11(3):6-13. doi:10.32481/djph.2025.09.03
Camchong J, Lim KO, Kumra S. Adverse effects of cannabis on adolescent brain development: a longitudinal study. Cereb Cortex. 2017;27(3):1922-1930. doi:10.1093/cercor/bhw015
Centers for Disease Control and Prevention. States update number of hospitalized e-cigarette, or vaping, product use–associated lung injury (EVALI) cases and EVALI deaths. Published February 25, 2020. Accessed December 28, 2025. https://archive.cdc.gov/www_cdc_gov/media/releases/2020/s0225-EVALI-cases-deaths.html
Cservenka A, Lahanas S, Dotson-Bossert J. Marijuana use and hypothalamic-pituitary-adrenal axis functioning in humans. Front Psychiatry. 2018;9:472. doi:10.3389/fpsyt.2018.00472
Farrelly KN, Wardell JD, Marsden E, Scarfe ML, Najdzionek P, Turna J, MacKillop J. The impact of recreational cannabis legalization on cannabis use and associated outcomes: a systematic review. Subst Abuse. 2023;17:11782218231172054. doi:10.1177/11782218231172054
Florimbio AR, Walton MA, Duval ER, Bauermeister JA, Young SD, McAfee J, Bonar EE. Direct and indirect effects of cannabis risk perceptions on cannabis use frequency. Addict Res Theory. 2024;32(1):68-73. doi:10.1080/16066359.2023.2221029
Gukasyan N, Strain EC. Relationship between cannabis use frequency and major depressive disorder in adolescents: findings from the National Survey on Drug Use and Health 2012–2017. Drug Alcohol Depend. 2020;208:107867. doi:10.1016/j.drugalcdep.2020.107867
Hammond CJ, Chaney A, Hendrickson B, Sharma P. Cannabis use among US adolescents in the era of marijuana legalization: a review of changing use patterns, comorbidity, and health correlates. Int Rev Psychiatry. 2020;32(3):221-234. doi:10.1080/09540261.2020.1713056
Hurd YL, Manzoni OJ, Pletnikov MV, Lee FS, Bhattacharyya S, Melis M. Cannabis and the developing brain: insights into its long-lasting effects. J Neurosci. 2019;39(42):8250-8258. doi:10.1523/JNEUROSCI.1165-19.2019
Lapham GT, Matson TE, Bobb JF, Luce C, Oliver MM, Hamilton LK, Bradley KA. Prevalence of cannabis use disorder and reasons for use among adults in a US state where recreational cannabis use is legal. JAMA Netw Open. 2023;6(8):e2328934. doi:10.1001/jamanetworkopen.2023.28934
Lee J, Krishnan-Sarin S, Kong G. Social media use and cannabis vaping initiation among US youth. Drug Alcohol Depend. 2023;249:109949. doi:10.1016/j.drugalcdep.2023.109949
Mattingly DT, Richardson MK, Hart JL. Prevalence of and trends in current cannabis use among US youth and adults, 2013–2022. Drug Alcohol Depend Rep. 2024;12:100253. doi:10.1016/j.dadr.2024.100253
Nguyen N, Peyser ND, Olgin JE, Pletcher MJ, Beatty AL, Modrow MF, Carton TW, Khatib R, Djibo DA, Ling PM, Marcus GM. Associations between tobacco and cannabis use and anxiety and depression among adults in the United States: findings from the COVID-19 citizen science study. PLoS One. 2023;18(9):e0289058. doi:10.1371/journal.pone.0289058
Queiroz APS, Pozzolo Pedro MO, Waisman Campos M, Torales J, Ventriglio A, Castaldelli-Maia JM. Cognitive effects of cannabis use: a comprehensive review across domains. Neurol Int. 2025;17(7):107. doi:10.3390/neurolint17070107
Ross JA, Levy S. The impact of cannabis use on adolescent neurodevelopment and clinical outcomes amidst changing state policies. Clin Ther. 2023;45(6):535-540. doi:10.1016/j.clinthera.2023.03.009
Schauer GL, Njai R, Grant-Lenzy AM. Modes of marijuana use—smoking, vaping, eating, and dabbing: results from the 2016 BRFSS in 12 states. Drug Alcohol Depend. 2020;209:107900. doi:10.1016/j.drugalcdep.2020.107900
Scheyer AF, Laviolette SR, Pelissier AL, Manzoni OJ. Cannabis in adolescence: lasting cognitive alterations and underlying mechanisms. Cannabis Cannabinoid Res. 2023;8(1):12-23. doi:10.1089/can.2022.0183
Smart R, Pacula RL. Early evidence of the impact of cannabis legalization on cannabis use, cannabis use disorder, and the use of other substances: findings from state policy evaluations. Am J Drug Alcohol Abuse. 2019;45(6):644-663. doi:10.1080/00952990.2019.1669626
Substance Abuse and Mental Health Services Administration. Key substance use and mental health indicators in the United States: results from the 2022 National Survey on Drug Use and Health. Published 2023. Accessed December 28, 2025. https://www.samhsa.gov/data/report/2022-nsduh-annual-national-report
Substance Abuse and Mental Health Services Administration. 2023 National Survey on Drug Use and Health public use file codebook. Accessed December 28, 2025. https://www.samhsa. gov/data/system/files/media-puf-file/nsduh-2023-ds0001-infocodebook_v2.pdf- 
Substance Abuse and Mental Health Services Administration. Know the effects, risks, and side effects of marijuana. Published November 2024. Accessed December 28, 2025. https://www.samhsa.gov/marijuana
Velzeboer R, Malas A, Wei S, Berger R, Parmar V, Lai WWK. Cannabis and sleep architecture: a systematic review and meta-analysis. Sleep Med Rev. 2025;84:102164. doi:10.1016/j.smrv.2025.102164
Whiteley L, Haubrick KK, Arnold T, Craker L, Olsen E, Hershkowitz D, Brown LK. Motivators for cannabis use among young adults in outpatient psychiatric care: a qualitative study. J Drug Issues. 2021;51(3):590-604. doi:10.1177/00220426211002125




```{r}

# NSDUH (2021-2023 + 2024) - YOUTH: 

library(survey)
library(svydiags)
library(tidyverse)
library(naniar)
library(stats)
library(jtools)
library(haven)
library(labelled)
library(scales)
library(ggplot2)
library(broom)
library(gt)
library(purrr)
library(forcats)
library(dplyr)

nsduh_2024 <- read_dta("../database/NSDUH_2024.dta")
nsduh_2021_2023 <- read_dta("../database/NSDUH_2021_2023.dta")


nsduh_2123 <- nsduh_2021_2023 %>%
  filter(AGE3 %in% c(1,2,3)) %>%
  mutate(YEAR = as.numeric(YEAR)) %>%
  rename(ANALWT2_C = ANALWT2_C1) %>%
  rename_with(toupper)

nsduh_2024 <- nsduh_2024 %>%
  filter(AGE3 %in% c(1,2,3)) %>%
  mutate(YEAR = 2024) %>%
  rename_with(toupper)

nsduh_all <- bind_rows(nsduh_2123, nsduh_2024)


```


```{r}

vars_keep <- c(
  "YEAR","MRJYR","MJREC","YMDERSUD5ANY","YMDESUD5ANYO",
  "AGE3","IRSEX","NEWRACE2","COUTYP4","PDEN10","IRINSUR4","IRFAMIN3",
  "POVERTY3","EDUSKPEST","IRPYUD5MRJ","IRPYUD5ALC", "IRPYUD5COC", 
  "IRPYUD5HER", "IRPYUD5HAL", "IRPYUD5INH", "IRPYUD5MTH",
  "ANALWT2_C3","ANALWT2_C","VESTR_C","VEREP"
)

nsduh_all <- nsduh_all |>  dplyr:: select(any_of(vars_keep))

missing_vals <- list(
  MJREC = c(91,97,98))

nsduh_all <- replace_with_na(nsduh_all, missing_vals)

nsduh_all <- nsduh_all %>%
  rename(
    year = YEAR,
    mj_past_year =MRJYR,
    mj_recency = MJREC,
    sud_or_mde_raw = YMDERSUD5ANY,
    mde_sud_raw = YMDESUD5ANYO,
    age_cat = AGE3,
    sex = IRSEX,
    race = NEWRACE2,
    county_type = COUTYP4,
    pop_density = PDEN10,
    insurance = IRINSUR4,
    family_income = IRFAMIN3,
    poverty = POVERTY3,
    mrj_use_disorder = IRPYUD5MRJ
  )


nsduh_all <- nsduh_all %>%
  mutate(
    mj_past_year_num = ifelse(mj_past_year ==1,1,0),
    mj_past_month_num = ifelse(mj_recency %in% c(1,11), 1, 0),
    sud_or_mde_num = ifelse(sud_or_mde_raw == 1, 1, 0),
    mrj_use_disorder_num = ifelse (mrj_use_disorder == 1,1,0) 
)

nsduh_all <- nsduh_all %>%
  mutate(subpop = ifelse(!is.na(age_cat) & !is.na(sex), 1, 0))

nsduh_all <- nsduh_all %>%
  mutate(
    year = factor(year),
    age_cat = factor(age_cat, 1:3, c("12–13","14–15","16–17")),
    sex = factor(sex, 1:2, c("Male","Female")),
    race = factor(race, 1:7,
      c("White","Black","AIAN","NHPI","Asian","Multiracial","Hispanic")),
    county_type = factor(county_type, 1:3,
      c("Large metro","Small metro","Nonmetro")),
    pop_density = factor(pop_density, 1:3,
      c("≥1M CBSA","<1M CBSA","Non-CBSA")),
    insurance = factor(insurance, levels = c(1,2), labels = c("Yes","No")),
    sud_or_mde_num = factor(sud_or_mde_num, levels = c(1:3), labels = c("Yes","No", "NA")),
    mj_past_month_num = factor(mj_past_month_num, levels = c(1,0), labels = c("Yes","No")),
    mj_past_year_num = factor(mj_past_year_num, levels = c(1,0), labels = c("Yes","No")),
    mrj_use_disorder_num = factor (mrj_use_disorder_num, levels = c(1,0), labels = c("Yes","No")), 
    family_income = factor(family_income, 1:7,
      c("<$10k","$10–19k","$20–29k","$30–39k","$40–49k","$50–74k","≥$75k")),
    poverty = factor(poverty, 1:3,
      c("Living in Poverty", "Income Up to 2X Federal Poverty Threshold", "Income More Than 2X Federal Poverty Threshold")),
    mde_sud_raw = factor(mde_sud_raw, 1:5, 
                         c("SUD only", "MDE only", "SUD and MDE", "Neither", "NA"))
  )

var_label(nsduh_all) <- list(
  year = "Survey year",
  age_cat = "Age group (years)",
  sex = "Sex",
  race = "Race/Ethnicity",
  county_type = "County type",
  pop_density = "Population density (CBSA)",
  insurance = "Health insurance coverage",
  family_income = "Family income",
  poverty = "Poverty level",
  mj_past_year_num = "Marijuana use in the past year (binary)",
  mj_past_month_num = "Marijuana use in the past 30 days (binary)",
  sud_or_mde_raw = "Presence of MDE or SUD (Past Year)",
  sud_or_mde_num = "Presence of MDE or SUD (Past Year)(binary)",
  mde_sud_raw = "Past-year MDE and SUD status (DSM-5)",
  mrj_use_disorder_num = "Marijuana Use Disorder in the past 12 months"
) 

## First object (adolescents aged between 12 to 17 year)

nsduh_sp <- svydesign(
  id = ~VEREP,
  strata = ~VESTR_C,
  weights = ~ANALWT2_C,
  data = nsduh_all,
  nest = TRUE
)

dim(nsduh_sp)

```


```{r}


vars_keep <- c(
  "YEAR","MRJYR","MJREC","YMDERSUD5ANY","YMDESUD5ANYO",
  "AGE3","IRSEX","NEWRACE2","COUTYP4","PDEN10","IRINSUR4","IRFAMIN3",
  "POVERTY3","EDUSKPEST","IRPYUD5MRJ","IRPYUD5ALC", "IRPYUD5COC", 
  "IRPYUD5HER", "IRPYUD5HAL", "IRPYUD5INH", "IRPYUD5MTH",
  "ANALWT2_C3","ANALWT2_C","VESTR_C","VEREP"
)

nsduh_all <- nsduh_all |>  dplyr:: select(any_of(vars_keep))

nsduh_all <- nsduh_all %>%
  rename(
    year = YEAR,
    mj_past_year = MRJYR,
    mj_recency = MJREC,
    sud_or_mde_raw = YMDERSUD5ANY,
    mde_sud_raw = YMDESUD5ANYO,
    age_cat = AGE3,
    sex = IRSEX,
    race = NEWRACE2,
    county_type = COUTYP4,
    pop_density = PDEN10,
    insurance = IRINSUR4,
    family_income = IRFAMIN3,
    poverty = POVERTY3,
    mrj_use_disorder = IRPYUD5MRJ
  )


nsduh_all <- nsduh_all %>%
  mutate(

    # MJREC — 3 categories
    mj_past_month_3cat = case_when(
      mj_recency %in% c(1, 11) ~ "Yes",
      mj_recency %in% c(2, 3, 8, 9) ~ "No",
      mj_recency %in% c(91, 97, 98) ~ "Never used/Unknown",
      TRUE ~ NA_character_
    ),

    # YMDERSUD5ANY — 3 categories
    sud_or_mde_3cat = case_when(
      sud_or_mde_raw == 1 ~ "Yes",
      sud_or_mde_raw == 0 ~ "No",
      is.na(sud_or_mde_raw) ~ "Unknown"
    ),

    # YMDESUD5ANYO — 5 categories
    mde_sud_5cat = case_when(
      mde_sud_raw == 1 ~ "SUD only",
      mde_sud_raw == 2 ~ "MDE only",
      mde_sud_raw == 3 ~ "SUD and MDE",
      mde_sud_raw == 4 ~ "Neither",
      is.na(mde_sud_raw) ~ "Unknown"
    )
  )

 
nsduh_all <- nsduh_all %>%
  mutate(
    mj_past_month_bin = case_when(
      mj_recency %in% c(1, 11) ~ 1,
      mj_recency %in% c(2, 3, 8, 9) ~ 0,
      TRUE ~ NA_real_
    ),

    mj_past_year_bin = case_when(
      mj_past_year == 1 ~ 1,
      mj_past_year == 0 ~ 0,
      TRUE ~ NA_real_
    ),

    sud_or_mde_bin = case_when(
      sud_or_mde_raw == 1 ~ 1,
      sud_or_mde_raw == 0 ~ 0,
      TRUE ~ NA_real_
    ),

    mrj_use_disorder_bin = case_when(
      mrj_use_disorder == 1 ~ 1,
      mrj_use_disorder == 0 ~ 0,
      TRUE ~ NA_real_
    )
  )

nsduh_all <- nsduh_all %>%
  mutate(subpop = ifelse(!is.na(age_cat) & !is.na(sex), 1, 0))


nsduh_all <- nsduh_all %>%
  mutate(
    year = factor(year),
    age_cat = factor(age_cat, 1:3, c("12–13","14–15","16–17")),
    sex = factor(sex, 1:2, c("Male","Female")),
    race = factor(race, 1:7,
                  c("White","Black","AIAN","NHPI","Asian","Multiracial","Hispanic")),
    county_type = factor(county_type, 1:3,
                         c("Large metro","Small metro","Nonmetro")),
    pop_density = factor(pop_density, 1:3,
                         c("≥1M CBSA","<1M CBSA","Non-CBSA")),
    insurance = factor(insurance, c(1,2), c("Yes","No")),
    family_income = factor(family_income, 1:7,
                           c("<$10k","$10–19k","$20–29k","$30–39k",
                             "$40–49k","$50–74k","≥$75k")),
    poverty = factor(poverty, 1:3,
                     c("Living in Poverty",
                       "Income ≤2× Federal Poverty Threshold",
                       "Income >2× Federal Poverty Threshold")),
    mj_past_month_3cat = factor(
      mj_past_month_3cat,
      levels = c("Yes","No","Never used/Unknown")
    ),
    sud_or_mde_3cat = factor(
      sud_or_mde_3cat,
      levels = c("Yes","No","Unknown")
    ),
    mde_sud_5cat = factor(
      mde_sud_5cat,
      levels = c("SUD only","MDE only","SUD and MDE","Neither",
                 "Unknown")
    )
  )

var_label(nsduh_all) <- list(
  year = "Survey year",
  age_cat = "Age group (years)",
  sex = "Sex",
  race = "Race/Ethnicity",
  county_type = "County type",
  pop_density = "Population density (CBSA)",
  insurance = "Health insurance coverage",
  family_income = "Family income",
  poverty = "Poverty level",
  mj_past_month_3cat = "Marijuana use in the past 30 days",
  sud_or_mde_3cat = "Past-year MDE or SUD (DSM-5 criteria)",
  mde_sud_5cat = "Past-year MDE and SUD status (DSM-5 criteria)",
  mj_past_month_bin = "Marijuana use in the past 30 days (binary)",
  mj_past_year_bin = "Marijuana use in the past year (binary)",
  sud_or_mde_bin = "Past-year MDE or SUD (binary)",
  mrj_use_disorder_bin = "Marijuana Use Disorder (past year)"
)


nsduh_sp <- svydesign(
  id = ~VEREP,
  strata = ~VESTR_C,
  weights = ~ANALWT2_C,
  data = nsduh_all,
  nest = TRUE
)

dim(nsduh_sp)





```



# Study Population 
# Figure 1: Prevalence of Past-Year Cannabis Use Among U.S. Adolescents (2021-2024)

```{r}


sample_counts <- nsduh_all %>%
  group_by(year) %>%
  summarise(
    adolescent_n = sum(subpop == 1, na.rm = TRUE) 
  )

nsduh_sp$variables$one <- 1

pop_counts <- svyby(
  ~one, 
  ~year + subpop, 
  design = nsduh_sp, 
  FUN = svytotal, 
  na.rm = TRUE
)

pop_counts_clean <- pop_counts %>%
  filter(subpop == 1) %>%
  select(year, one) %>%
  rename(estimated_population = one)

demographics_table <- sample_counts %>%
  left_join(pop_counts_clean, by = "year") %>%
  mutate(estimated_pop_fmt = scales::comma(estimated_population)
  )

demographics_table %>%
  select(year, adolescent_n, estimated_pop_fmt) %>%
  gt() %>%
  tab_header(
    title = "Sample Size and Population Representativeness",
    subtitle = "Comparison of Unweighted Sample (n) vs. Weighted Population Estimate (N)"
  ) %>%
  cols_label(
    adolescent_n = " Adolescents with Complete Data for Age and Sex in the Survey Sample (n)",
    estimated_pop_fmt = "Est. US Adolescent Pop. (N)"
  ) 


total_pop <- svytotal(~one, design = nsduh_sp, na.rm = TRUE)
total_pop

prev_year <- svyby(
  ~mj_past_year_bin, ~year, design = nsduh_sp,  FUN = svymean, vartype = "ci", na.rm = TRUE
)

prev_year <- prev_year %>%
  mutate(
    prevalence = mj_past_year_bin * 100, 
    ci_l = ci_l * 100,
    ci_u = ci_u * 100
  )

prev_year

#Cannabis users past year (2021-2024 N)
n_unweighted_year <- sum(nsduh_all$mj_past_year_bin == 1, na.rm = TRUE)
n_unweighted_year

#Cannabis users past month (2021-2024 N)
n_unweighted_month <- sum(nsduh_all$mj_past_month_bin == 1, na.rm = TRUE)
n_unweighted_month


# Figure 1
ggplot(prev_year, aes(x = year, y = prevalence)) +
  geom_line(
  group = 1,
  linewidth = 0.6,
  color = "black"
)+
  geom_point(size = 3, color = "black") +
  geom_errorbar(
    aes(ymin = ci_l, ymax = ci_u),
    width = 0.1,
    linewidth = 0.6,
    color = "black"
  ) +
  geom_text(
    aes(label = sprintf("%.1f%%", prevalence)),
    vjust = -3,
    size = 3.5,
    color = "black"
  ) +
  scale_y_continuous(
    limits = c(0, 20),
    breaks = seq(0, 20, by = 5),
    labels = scales::percent_format(scale = 1)
  ) +
  labs(
    x = "Survey Year",
    y = "Prevalence (%)",
    caption = "Error bars indicate 95% confidence intervals."
  ) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    panel.grid.major.y = element_line(color = "grey85"),
    axis.title = element_text(face = "bold"),
    axis.text = element_text(color = "black"),
  )

```


## Any difference in use between 2022 and 2024? 

```{r}

# Past - year use:


nsduh_sp <- update(
  nsduh_sp,
  year = factor(year, levels = c("2021", "2022", "2023", "2024"))
)

# Year of reference: 2022
nsduh_sp <- update(
  nsduh_sp,
  year = relevel(year, ref = "2022")
)


nsduh_sp <- update(
  nsduh_sp,
  mj_past_year_bin = as.numeric(mj_past_year_bin == 1)
)

model_year <- svyglm(
  mj_past_year_bin ~ year,
  design = nsduh_sp,
  family = quasibinomial()
)

year_results <- tidy(
  model_year,
  exponentiate = TRUE,
  conf.int = TRUE
)

table_year <- year_results %>%
  filter(term != "(Intercept)") %>%
  mutate(
    Year = gsub("year", "", term),
    AOR = round(estimate, 2),
    CI_low = round(conf.low, 2),
    CI_high = round(conf.high, 2),
    p_value = round(p.value, 3)
  ) %>%
  select(Year, AOR, CI_low, CI_high, p_value)

ref_row <- tibble(
  Year = "2022 (REF)",
  AOR = 1.00,
  CI_low = NA,
  CI_high = NA,
  p_value = NA
)

table_year <- bind_rows(ref_row, table_year)

table_year

```


# Supplementary Table 1 : Sociodemographic Characteristics of the Study Population by Year (2021–2024)

```{r}

nsduh_sp <- update(
  nsduh_sp,
  year = relevel(year, ref = "2021")
) 

covariates_labels <- c(
  sex = "Sex",
  age_cat = "Age group",
  race = "Race/Ethnicity",
  county_type = "County type",
  pop_density = "Population density",
  insurance = "Health insurance",
  family_income = "Family income",
  poverty = "Poverty status",
  mj_past_year_bin = "Marijuana use in the past year (binary)",
  mj_past_month_3cat = "Marijuana use in the past 30 days",
  mrj_use_disorder_bin = "Marijuana Use Disorder in the past 12 months",
  sud_or_mde_3cat = "Past-year MDE or SUD Status (DSM-5 criteria)", 
  mde_sud_5cat = "Past-year MDE and SUD Categories (DSM-5 criteria)"
  
)

get_distribution <- function(var_name, label_var) {
  tryCatch({

    var_data <- nsduh_sp$variables[[var_name]]

    if (length(unique(na.omit(var_data))) < 2) {
      return(NULL)
    }

    res <- svyby(
      as.formula(paste0("~", var_name)),
      by = ~year,
      design = nsduh_sp,
      FUN = svymean,
      vartype = "ci",
      na.rm = TRUE
    )

    # ----- Detect binary variables (0/1) -----
    is_binary <- all(unique(na.omit(var_data)) %in% c(0, 1))

    if (is_binary) {

      # names created by svyby:
      #   var_name
      #   ci_l.var_name
      #   ci_u.var_name

      mean_col <- var_name
      ci_l_col <- paste0("ci_l.", var_name)
      ci_u_col <- paste0("ci_u.", var_name)

      res_formatted <- res %>%
        transmute(
          year,
          level_label = "Yes",
          mean = .data[[mean_col]],
          ci_l = .data[[ci_l_col]],
          ci_u = .data[[ci_u_col]],
          result_formatted = sprintf(
            "%.2f (%.2f, %.2f)",
            mean * 100, ci_l * 100, ci_u * 100
          ),
          variable_group = label_var
        )

    } else {

      # ----- Categorical variables -----
      res_formatted <- res %>%
        pivot_longer(-year, names_to = "col_name", values_to = "value") %>%
        mutate(
          stat_type = case_when(
            grepl("^ci_l", col_name) ~ "ci_l",
            grepl("^ci_u", col_name) ~ "ci_u",
            TRUE ~ "mean"
          ),
          level_label = col_name %>%
            gsub("^ci_l\\.|^ci_u\\.", "", .) %>%
            gsub(paste0("^", var_name), "", .)
        ) %>%
        select(year, level_label, stat_type, value) %>%
        pivot_wider(names_from = stat_type, values_from = value) %>%
        mutate(
          result_formatted = sprintf(
            "%.2f (%.2f, %.2f)",
            mean * 100, ci_l * 100, ci_u * 100
          ),
          variable_group = label_var
        )
    }

    res_formatted

  }, error = function(e) {
    message("ERRO em ", var_name, ": ", e$message)
    NULL
  })
}

dist_data_long <- map_dfr(
  names(covariates_labels),
  ~ get_distribution(.x, covariates_labels[.x])
)

dist_data_wide <- dist_data_long %>%
  select(variable_group, level_label, year, result_formatted) %>%
  pivot_wider(names_from = year, values_from = result_formatted)

gt_table_profile <- dist_data_wide %>%
  gt(groupname_col = "variable_group", rowname_col = "level_label") %>%
  tab_header(
    title = "Characteristics of the Study Population: U.S. Adolescents Aged 12–17 Years, NSDUH 2021–2024",
    subtitle = "Weighted Prevalence (95% CI)"
  ) %>%
  cols_align(align = "center", columns = everything()) %>%
  cols_align(align = "left", columns = stub()) %>%
  tab_options(
    row_group.font.weight = "bold",
    table.font.size = 12
  )

gt_table_profile

```


```{r}
library(gt)

gtsave(gt_table_profile, "Tabela1_NSUDH_GT.html")
gtsave(gt_table_profile, filename = "Tabela1_NSUDH.docx")
```



# Table 1: Sociodemographic characteristics of US adolescents with past-year cannabis use by year (Weighted prevalence), 2021–2024

```{r}


adolescents_use_year <- subset(nsduh_sp, mj_past_year_bin == 1)



get_distribution <- function(var_name, label_var, design_data) {
  tryCatch({

    var_data <- design_data$variables[[var_name]]

    if (length(unique(na.omit(var_data))) < 2) {
      return(NULL)
    }

    res <- svyby(
      as.formula(paste0("~", var_name)),
      by = ~year,
      design = design_data,
      FUN = svymean,
      vartype = "ci",
      na.rm = TRUE
    )

    is_binary <- all(unique(na.omit(var_data)) %in% c(0, 1))

    if (is_binary) {

      mean_col <- var_name
      ci_l_col <- paste0("ci_l.", var_name)
      ci_u_col <- paste0("ci_u.", var_name)

      res_formatted <- res %>%
        transmute(
          year,
          level_label = "Yes",
          mean = .data[[mean_col]],
          ci_l = .data[[ci_l_col]],
          ci_u = .data[[ci_u_col]],
          result_formatted = sprintf(
            "%.2f (%.2f, %.2f)",
            mean * 100, ci_l * 100, ci_u * 100
          ),
          variable_group = label_var
        )

    } else {

      res_formatted <- res %>%
        pivot_longer(-year, names_to = "col_name", values_to = "value") %>%
        mutate(
          stat_type = case_when(
            grepl("^ci_l", col_name) ~ "ci_l",
            grepl("^ci_u", col_name) ~ "ci_u",
            TRUE ~ "mean"
          ),
          level_label = col_name %>%
            gsub("^ci_l\\.|^ci_u\\.", "", .) %>%
            gsub(paste0("^", var_name), "", .)
        ) %>%
        select(year, level_label, stat_type, value) %>%
        pivot_wider(names_from = stat_type, values_from = value) %>%
        mutate(
          result_formatted = sprintf(
            "%.2f (%.2f, %.2f)",
            mean * 100, ci_l * 100, ci_u * 100
          ),
          variable_group = label_var
        )
    }

    res_formatted

  }, error = function(e) {
    message("ERRO em ", var_name, ": ", e$message)
    NULL
  })
}


sociodemographic_labels <- covariates_labels[c("sex", "age_cat", "race", 
                                                "county_type", "pop_density",
                                                "insurance", "family_income",
                                                "poverty", "mj_past_month_3cat", 
                                                "mrj_use_disorder_bin", 
                                                "sud_or_mde_3cat", "mde_sud_5cat")]

dist_data_long <- map_dfr(
  names(sociodemographic_labels),
  ~ get_distribution(.x, sociodemographic_labels[.x], adolescents_use_year)
)

dist_data_wide <- dist_data_long %>%
  select(variable_group, level_label, year, result_formatted) %>%
  pivot_wider(names_from = year, values_from = result_formatted)

gt_table_profile2 <- dist_data_wide %>%
  gt(groupname_col = "variable_group", rowname_col = "level_label") %>%
  tab_header(
    title = "Sociodemographic and Mental Health Profile of US Adolescents With Past-Year Cannabis Use, 2021–2024",
    subtitle = "NSDUH 2021–2024, Weighted Prevalence (95% CI)"
  ) %>%
  cols_align(align = "center", columns = everything()) %>%
  cols_align(align = "left", columns = stub()) %>%
  tab_options(
    row_group.font.weight = "bold",
    table.font.size = 12
  )

gt_table_profile2

```


```{r}
library(gt)

gtsave(gt_table_profile2, "Tabela2_NSUDH_GT.html")
gtsave(gt_table_profile2, filename = "Tabela2_NSUDH.docx")
```





# Among adolescents who reported past-year cannabis use, what was the prevalence of marijuana use disorder?
# Which sociodemographic factors were independently associated with increased risk of CUD?

```{r}


nsduh_pooled <- nsduh_all  
nsduh_pooled$weight_pooled <- nsduh_pooled$ANALWT2_C / 4

nsduh_design <- svydesign(
  id = ~VEREP,
  strata = ~VESTR_C,
  weights = ~weight_pooled,
  data = nsduh_pooled,
  nest = TRUE
)

nsduh_design <- update(nsduh_design, mrj_use_disorder_bin = ifelse(mrj_use_disorder == 1, 1, 0))
nsduh_design <- update(nsduh_design, mj_past_year_bin = ifelse(mj_past_year_num == "Yes", 1, 0))

adolescents_users <- subset(nsduh_design, mj_past_year_bin == 1 & !is.na(mrj_use_disorder_bin))

# Prevalence
svyby(~mrj_use_disorder_bin, ~year, adolescents_users, svymean, na.rm = TRUE)

model_adj <- svyglm(
  mrj_use_disorder_bin ~ age_cat + sex + race + family_income + year,
  design = adolescents_users,
  family = quasibinomial()
)
summary(model_adj)

exp(cbind(OR = coef(model_adj), confint(model_adj)))

```

# Fig 2. Prevalence of different modes of marijuana use among past-year users (2022-2024)
# Were there significant year-to-year trends in marijuana use by mode of administration among adolescents? 

```{r}

nsduh_2224 <- bind_rows(
  nsduh_2123 %>% filter(YEAR %in% c(2022,2023)),
  nsduh_2024
)

vars_keep_subset <- c(
  "YEAR","MRJYR","MJREC","AGE3","IRSEX","IRPYUD5MRJ","MJYRSMOKE","MJYRVAPE","MJYRDAB",
  "MJYREAT","MJYRMOUTH","MJYRSKIN","MJYRPILL","MJYROTHER",
  "ANALWT2_C3","ANALWT2_C","VESTR_C","VEREP"
)

nsduh_2224 <- nsduh_2224 %>% select(any_of(vars_keep_subset))

missing_vals <- list(
  MJYRSMOKE = c(91,93,94,97,98), 
  MJYRVAPE = c(91,93,94,97,98), 
  MJYRDAB = c(91,93,94,97,98), 
  MJYREAT = c(91,93,94,97,98), 
  MJYRMOUTH = c(91,93,94,97,98), 
  MJYRSKIN = c(91,93,94,97,98), 
  MJYRPILL = c(91,93,94,97,98), 
  MJYROTHER = c(91,93,94,97,98)
)

nsduh_2224 <- replace_with_na(nsduh_2224, missing_vals)

nsduh_2224 <- nsduh_2224 %>%
  mutate(
    mj_past_year_bin = ifelse(MRJYR %in% c(1), 1,
                           ifelse(MRJYR %in% c(0), 0, NA)),
    mj_smoke_bin  = ifelse(MJYRSMOKE %in% c(1,3,5), 1,
                           ifelse(MJYRSMOKE %in% c(2), 0, NA)),
    mj_vape_bin   = ifelse(MJYRVAPE %in% c(1,3,5), 1,
                           ifelse(MJYRVAPE %in% c(2,4), 0, NA)),
    mj_dab_bin    = ifelse(MJYRDAB %in% c(1,3,5), 1,
                           ifelse(MJYRDAB %in% c(2,4), 0, NA)),
    mj_eat_bin    = ifelse(MJYREAT %in% c(1,3,5), 1,
                           ifelse(MJYREAT %in% c(2,4), 0, NA)),
    mj_mouth_bin  = ifelse(MJYRMOUTH %in% c(1,3,5), 1,
                           ifelse(MJYRMOUTH %in% c(2,4), 0, NA)),
    mj_skin_bin   = ifelse(MJYRSKIN %in% c(1,3,5), 1,
                           ifelse(MJYRSKIN %in% c(2,4), 0, NA)),
    mj_pill_bin   = ifelse(MJYRPILL %in% c(1,5), 1,
                           ifelse(MJYRPILL %in% c(2,4), 0, NA)),
    mj_other_bin  = ifelse(MJYROTHER %in% c(1,5), 1,
                           ifelse(MJYROTHER %in% c(2,4), 0, NA))
  )

nsduh_2224 <- nsduh_2224 %>%
  mutate(
    YEAR = factor(YEAR),
    AGE3 = factor(AGE3, levels=1:3, labels=c("12–13","14–15","16–17")),
    IRSEX = factor(IRSEX, levels=1:2, labels=c("Male","Female")),
    across(ends_with("_bin"), ~factor(., levels=c(1,0), labels=c("Yes","No")))
  )

var_label(nsduh_2224) <- list(
  YEAR = "Survey year",
  AGE3 = "Age group (years)",
  IRSEX = "Sex",
  mj_past_year_bin = "Marijuana use in past year (binary)",
  mj_smoke_bin  = "Marijuana use - Smoking",
  mj_vape_bin   = "Marijuana use - Vaping",
  mj_dab_bin    = "Marijuana use - Dabbing (waxes/concentrates)",
  mj_eat_bin    = "Marijuana use - Edibles (food/drink)",
  mj_mouth_bin  = "Marijuana use - Oral (Drops/Sprays)",
  mj_skin_bin   = "Marijuana use - Topical (skin)",
  mj_pill_bin   = "Marijuana use - Pills",
  mj_other_bin  = "Marijuana use - Other methods"
)

nsduh_sub <- svydesign(
  id = ~VEREP,
  strata = ~VESTR_C,
  weights = ~ANALWT2_C,
  data = nsduh_2224,
  nest = TRUE
)

run_trend_adj <- function(var, design_obj) {
  f <- as.formula(paste0("I(", var, " == 'Yes') ~ YEAR"))
  mod <- svyglm(f, design = design_obj, family = quasibinomial())
  broom::tidy(mod, exponentiate = TRUE, conf.int = TRUE) %>%
    filter(grepl("YEAR", term)) %>%
    mutate(Method = var)
}

method_labels <- c(
  mj_smoke_bin  = "Smoking",
  mj_vape_bin   = "Vaping",
  mj_dab_bin    = "Dabbing (waxes/concentrates)",
  mj_eat_bin    = "Edibles (food/drink)",
  mj_mouth_bin  = "Oral (Drops/Sprays)",
  mj_skin_bin   = "Topical (skin)",
  mj_pill_bin   = "Pills",
  mj_other_bin  = "Other"
)

format_p <- function(p){
  ifelse(p < 0.001, "<0.001", round(p, 3))
}

vars_adm <- names(method_labels)

trend_adj_results <- purrr::map_dfr(vars_adm, run_trend_adj, design_obj = nsduh_sub)

trend_adj_table <- trend_adj_results %>%
  transmute(
    Method  = method_labels[Method],
    OR      = round(estimate, 2),
    CI      = paste0("(", round(conf.low,2), "–", round(conf.high,2), ")"),
    p_value = format_p(p.value)
  )

trend_adj_table


legend_names <- method_labels

results_list <- list()
for(i in seq_along(vars_adm)){
  var_name <- vars_adm[i]
  label_name <- legend_names[i]
  
  form <- as.formula(paste0("~", var_name))
  
  tab <- svyby(form, ~YEAR, design = nsduh_sub, svymean, vartype = "ci", na.rm = TRUE)
  
  col_est <- paste0(var_name,"Yes")
  col_cil <- paste0("ci_l.", var_name,"Yes")
  col_ciu <- paste0("ci_u.", var_name,"Yes")
  
  df_temp <- data.frame(
    YEAR = tab$YEAR,
    prevalence = tab[[col_est]],
    ci_lower   = tab[[col_cil]],
    ci_upper   = tab[[col_ciu]],
    Method = label_name
  )
  
  results_list[[i]] <- df_temp
}

df_plot <- bind_rows(results_list)


print(df_plot)

ggplot(df_plot, aes(x = YEAR, y = prevalence, color = Method, group = Method)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0.1, alpha = 0.5) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    y = "Prevalence (%)",
    x = "Year",
    color = "Mode of Use"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank(),
    panel.grid.major.y = element_line(color = "grey85"),
    axis.title = element_text(face = "bold"),
    axis.text = element_text(color = "black")
  )



```


# What was the proportion of cannabis multimodal use?

```{r}

nsduh_mj_users <- subset(
  nsduh_sub,
  mj_past_year_bin == "Yes"
)

nsduh_mj_users <- update(
  nsduh_mj_users,
  smoke_n = ifelse(mj_smoke_bin == "Yes", 1, 0),
  vape_n  = ifelse(mj_vape_bin  == "Yes", 1, 0),
  dab_n   = ifelse(mj_dab_bin   == "Yes", 1, 0),
  eat_n   = ifelse(mj_eat_bin   == "Yes", 1, 0),
  mouth_n = ifelse(mj_mouth_bin == "Yes", 1, 0),
  skin_n  = ifelse(mj_skin_bin  == "Yes", 1, 0),
  pill_n  = ifelse(mj_pill_bin  == "Yes", 1, 0),
  other_n = ifelse(mj_other_bin == "Yes", 1, 0)
)

nsduh_mj_users <- update(
  nsduh_mj_users,
  n_modes =
    smoke_n +
    vape_n +
    dab_n +
    eat_n +
    mouth_n +
    skin_n +
    pill_n +
    other_n
)

nsduh_mj_users <- update(
  nsduh_mj_users,
  multimodal_use = factor(
    ifelse(n_modes >= 2, "Two or more modes", "One mode only"),
    levels = c("One mode only", "Two or more modes")
  )
)

svytable(~multimodal_use, nsduh_mj_users) %>%
  prop.table()

svytable(~n_modes, nsduh_mj_users) %>%
  prop.table()

nsduh_mj_users <- update(
  nsduh_mj_users,
  n_modes_cat = factor(
    case_when(
      n_modes == 1 ~ "1 mode",
      n_modes == 2 ~ "2 modes",
      n_modes >= 3 ~ "3+ modes"
    ),
    levels = c("1 mode", "2 modes", "3+ modes")
  )
)

svytable(~n_modes_cat, nsduh_mj_users) %>%
  prop.table()

svytable(~mj_smoke_bin + mj_vape_bin, design = nsduh_mj_users) %>%
  prop.table(margin = 1)

svytable(~mj_smoke_bin + mj_eat_bin, design = nsduh_mj_users) %>%
  prop.table(margin = 1)

oddis <- svyglm(
  I(multimodal_use == "Two or more modes") ~ YEAR + AGE3 + IRSEX,
  design = nsduh_mj_users,
  family = quasibinomial()
)

broom::tidy(
  oddis,
  exponentiate = TRUE,
  conf.int = TRUE
)


tab_multimodal <- svymean(
  ~I(multimodal_use == "Two or more modes"),
  design = nsduh_mj_users,
  na.rm = TRUE
)

confint(tab_multimodal)

table_or_adj <- broom::tidy(
  oddis,
  exponentiate = TRUE,
  conf.int = TRUE
) %>%
  filter(term != "(Intercept)") %>%
  mutate(
    Variable = recode(
      term,
      "YEAR2023" = "Year: 2023 vs 2022",
      "YEAR2024" = "Year: 2024 vs 2022",
      "AGE314–15" = "Age: 14–15 vs 12–13",
      "AGE316–17" = "Age: 16–17 vs 12–13",
      "IRSEXFemale" = "Sex: Female vs Male"
    )
  ) %>%
  transmute(
    Variable,
    `Adjusted OR` = round(estimate, 2),
    `95% CI` = paste0(
      round(conf.low, 2), "–", round(conf.high, 2)
    ),
    `p-value` = ifelse(p.value < 0.001, "<0.001", round(p.value, 3))
  )

table_or_adj



```

# Do individuals who use cannabis via two or more modes (multimodal use) have a higher risk of past-year marijuana use disorder (IRPYUD5MRJ)?

```{r}

odd_multimodal <- svyglm(
  IRPYUD5MRJ ~ multimodal_use + YEAR + AGE3 + IRSEX,
  design = nsduh_mj_users,
  family = quasibinomial()
)


broom::tidy(
  odd_multimodal,
  exponentiate = TRUE,
  conf.int = TRUE
)


```

# Were there differences in the risk of past-year vaping among adolescents according to sex and age? 
# >>>>>>  NO

```{r}

vape_model <- svyglm(
  I(mj_vape_bin == "Yes") ~ IRSEX + AGE3,
  design = nsduh_sub,     
  family = quasibinomial()
)

vape_risk <- broom::tidy(vape_model, exponentiate = TRUE, conf.int = TRUE)
vape_risk


```

# Supplementary Table 2: Association between sociodemographic characteristics and current cannabis use among U.S. youth

```{r}

nsduh_pooled <- nsduh_all %>%
    mutate(
    weight_pooled = ANALWT2_C / 4,
    mj_past_year_num = ifelse(mj_past_year_num == "Yes", 1, 0), 
    family_income_cat = case_when(
      family_income %in% c("<$10k", "$10–19k") ~ "<$20k",
      family_income %in% c("$20–29k", "$30–39k") ~ "$20–39k",
      family_income == "$40–49k" ~ "$40–49k",
      family_income == "$50–74k" ~ "$50–74k",
      family_income == "≥$75k" ~ "≥$75k",
      TRUE ~ NA_character_), 
    family_income_cat = factor(family_income_cat,
      levels = c(
        "<$20k",
        "$20–39k",
        "$40–49k",
        "$50–74k",
        "≥$75k"
      ))) %>%
  mutate(family_income_cat = relevel(family_income_cat, ref = "≥$75k")
  )

nsduh_design_pooled <- svydesign(
  id = ~VEREP,
  strata = ~VESTR_C,
  weights = ~weight_pooled,
  data = nsduh_pooled,
  nest = TRUE
)

model_pooled <- svyglm(
  mj_past_year_num ~ age_cat + sex + race + family_income_cat + county_type,
  design = nsduh_design_pooled,
  family = quasibinomial()
)

pooled_results <- tidy(
  model_pooled,
  exponentiate = TRUE,
  conf.int = TRUE
) %>%
  filter(term != "(Intercept)") %>% 
  mutate(
    variable = case_when(
      str_detect(term, "^age_cat") ~ "Age",
      str_detect(term, "^sex") ~ "Gender",
      str_detect(term, "^race") ~ "Race/Ethnicity",
      str_detect(term, "^family_income_cat") ~ "Family Income",
      str_detect(term, "^county_type") ~ "County Type"
    ),
    level = str_remove_all(
      term,
      "^age_cat|^sex|^race|^family_income_cat|^county_type"
    ),
    aor_ci = sprintf("%.2f (%.2f–%.2f)", estimate, conf.low, conf.high),
    p_val = ifelse(p.value < 0.001, "<0.001", sprintf("%.3f", p.value))
  ) %>%
  select(variable, level, aor_ci, p_val)


pooled_results_final <- bind_rows(pooled_results) %>%
  mutate(variable = factor(variable, levels = c(
    "Age", "Gender", "Race/Ethnicity", "Family Income", "County Type"
  ))) %>%
  group_by(variable) %>%
  ungroup()


final_table_pooled <- pooled_results_final %>%
  gt(groupname_col = "variable", rowname_col = "level") %>%
  tab_stubhead(label = "Category") %>%
  cols_align(
  align = "center",
  columns = c(aor_ci, p_val)
)%>%
  cols_label(
    aor_ci = "AOR (95% CI)",
    p_val = "p-value"
  ) %>%
  tab_header(
    title = "Association between sociodemographic characteristics and current cannabis use among U.S. youth",
    subtitle = "NSDUH 2021–2024, adjusted odds ratios"
  ) %>%
  tab_options(
    row_group.background.color = "#E0E0E0",
    column_labels.font.weight = "bold"
  )


final_table_pooled



```

# Defyning SUD 

```{r}

sud_vars <- c("IRPYUD5ALC", "IRPYUD5COC", "IRPYUD5HER",
              "IRPYUD5HAL", "IRPYUD5INH", "IRPYUD5MTH",
              "mrj_use_disorder")

for (var in sud_vars) {
  nsduh_design_pooled$variables[[var]] <- as.numeric(as.character(nsduh_design_pooled$variables[[var]]))
}

sud_design <- subset(
  nsduh_design_pooled,
  mde_sud_raw %in% c("SUD only", "SUD and MDE")
)

sud_design$variables$other_drug_sud <- ifelse(
  rowSums(sud_design$variables[, sud_vars], na.rm = TRUE) == 0,
  1, 0
)

sud_vars_extended <- c(sud_vars, "other_drug_sud")

sud_proportions <- svymean(
  as.formula(paste("~", paste(sud_vars_extended, collapse = " + "))),
  design = sud_design,
  na.rm = TRUE
)

sud_proportions_df <- data.frame(
  SUD_type = names(coef(sud_proportions)),
  proportion = coef(sud_proportions),
  SE = SE(sud_proportions)
) %>%
  mutate(
    proportion_percent = round(proportion * 100, 1),
    lower_CI = round(pmax(0, proportion - 1.96 * SE) * 100, 1),
    upper_CI = round((proportion + 1.96 * SE) * 100, 1)
  )

sud_proportions_df


```


# Question : There is association between past-year marijuana use and the presence of major depressive episode and/or substance use disorder among adolescents?
#  >>>> There is a statistically significant association between past-year marijuana use and the presence of major depressive episode and/or substance use disorder among adolescents.

```{r}


svytable(~mj_past_year_num + sud_or_mde_num, design = nsduh_design_pooled)

svychisq(~mj_past_year_num + sud_or_mde_num, design = nsduh_design_pooled)

```

# Multivariable models were used to assess whether this association persisted after adjustment for sociodemographic factors.

```{r}

nsduh_pooled$sud_or_mde_bin <- ifelse(nsduh_pooled$sud_or_mde_num == "Yes", 1,
                                      ifelse(nsduh_pooled$sud_or_mde_num == "No", 0, NA))

nsduh_sub_new <- svydesign(
  id = ~VEREP,
  strata = ~VESTR_C,
  weights = ~weight_pooled,
  data = nsduh_pooled,
  nest = TRUE
)

model_adj <- svyglm(
  sud_or_mde_bin ~ mj_past_year_num + age_cat + sex + race + family_income_cat + county_type,
  design = nsduh_sub_new,
  family = quasibinomial()
)

results_adj <- tidy(
  model_adj,
  exponentiate = TRUE,
  conf.int = TRUE
) %>%
  mutate(
    category = case_when(
      str_detect(term, "^mj_past_year_num") ~ "Past-year marijuana use",
      str_detect(term, "^age_cat") ~ "Age",
      str_detect(term, "^sex") ~ "Gender",
      str_detect(term, "^race") ~ "Race/Ethnicity",
      str_detect(term, "^family_income_cat") ~ "Family Income",
      str_detect(term, "^county_type") ~ "County Type",
      TRUE ~ term
    ),
    level = str_remove_all(
      term,
      "^mj_past_year_num|^age_cat|^sex|^race|^family_income_cat|^county_type"
    ),
    aor_ci = sprintf("%.2f (%.2f–%.2f)", estimate, conf.low, conf.high),
    p_val = ifelse(p.value < 0.001, "<0.001", sprintf("%.3f", p.value))
  ) %>%
  select(category, level, aor_ci, p_val) %>%
  arrange(category, level)

results_adj

```

# Past-year marijuana use  and MDE/SUD categories

```{r}


nsduh_pooled <- nsduh_pooled %>%
  mutate(
    mj_past_year_num = relevel(factor(mj_past_year_num), ref = "0"),
    age_cat = relevel(factor(age_cat), ref = "12–13"),
    sex = relevel(factor(sex), ref = "Male"),
    race = relevel(factor(race), ref = "White"),
    family_income_cat = relevel(factor(family_income_cat), ref = "≥$75k"),
    county_type = relevel(factor(county_type), ref = "Large metro")
  )

nsduh_design <- svydesign(
  id = ~VEREP,
  strata = ~VESTR_C,
  weights = ~weight_pooled,
  data = nsduh_pooled,
  nest = TRUE
)

mde_sud_categories <- c("SUD only", "MDE only", "SUD and MDE")


run_mde_sud_model <- function(cat) {
  
  nsduh_pooled[[paste0("mde_", str_replace_all(cat, " ", "_"))]] <- ifelse(
    nsduh_pooled$mde_sud_raw == cat, 1, 0
  )
  
    design_bin <- update(nsduh_design, 
                       mde_bin = nsduh_pooled[[paste0("mde_", str_replace_all(cat, " ", "_"))]])
  
  
  model <- svyglm(
    mde_bin ~ mj_past_year_num + age_cat + sex + race + family_income_cat,
    design = design_bin,
    family = quasibinomial()
  )
  
 
  tidy(model, exponentiate = TRUE, conf.int = TRUE) %>%
    filter(str_detect(term, "mj_past_year_num")) %>%
    mutate(
      category = cat,
      aor_ci = sprintf("%.2f (%.2f–%.2f)", estimate, conf.low, conf.high),
      p_val = ifelse(p.value < 0.001, "<0.001", sprintf("%.3f", p.value))
    ) %>%
    select(category, aor_ci, p_val)
}


results_mj <- lapply(mde_sud_categories, run_mde_sud_model) %>%
  bind_rows()

ref_row <- tibble(
  category = "Neither (REF)",
  aor_ci = "REF",
  p_val = "REF"
)

results_mj <- bind_rows(ref_row, results_mj) %>%
  mutate(category = factor(category, levels = c("Neither (REF)", mde_sud_categories)))

results_mj


```




